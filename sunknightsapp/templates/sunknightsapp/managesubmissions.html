

{% extends "sunknightsapp/base.html" %}
{% block content %}
    <h3>Score Submissions</h3>

    <div class="table-responsive">
        <table id="points-submissions-table" class="display" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>User</th>
                <th>Tank</th>
{#                <th>Gamemode</th>#}
                <th>Score</th>
                <th>Proof</th>
{#                <th>Date</th>#}
                <th>Submitter Note</th>
                <th>Manager Note</th>
                <th>Points</th>
                <th>action</th>
            </tr>
            </thead>
        </table>
    </div>

    <h3>Fight Submissions</h3>
    <div class="table-responsive">
        <table id="fights-submissions-table" class="display" cellspacing="0" width="100%">
            <thead>
            <tr>
                <th>Winner</th>
                <th>Loser</th>
                <th>Proof</th>
                <th>Manager Note</th>

                {#                <th>Date</th>#}
                <th>Points Winner</th>
                <th>Points Loser</th>
                <th>action</th>
            </tr>
            </thead>
        </table>
    </div>



{% endblock %}


{% block scriptself %}
    <script>
        $(document).ready(function () {
            function decideScoreSubmission() {
                $('.decisionbtnfucker').click(function () {
                    var id = $(this).val();
                    var element = $(this);
                    var points = $("#points-manager-"+id).val()
                    var managerText=$("#manager-note-"+id).val()
                    if (managerText=="")
                        managerText="None"


                    var accepted=$(this).hasClass("approve-submission")

                    element.closest("tr").find('input,button').attr('disabled','true');

                    $.ajax({
                        type: 'POST',
                        url: "{% url 'ajaxhandler' %}",
                        data: {csrfmiddlewaretoken: csrftoken,ajax_action_id:{{ decideuserpointsubmissionid }},pk_id:id,managerText:managerText, accepted: accepted, points: points},
                        success: function (data, textStatus, xhr) {
                            console.log(data);
                            console.log(xhr);
                            if (xhr.status == '200') {
                                //table.row(element.closest("tr")).remove().draw(false)
                                element.closest("tr").remove();
                                $('#alertsContainer').append("<div class=\"alert alert-success alert-dismissible fade in\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>Approved Submission (" + data['message']['data']['id']+"): "+data['message']['data']['accepted'] + "<strong></div>")
                            }
                        }
                    });
                })
            }
            var tablescore=$('#points-submissions-table').DataTable({
                "fnDrawCallback": function (oSettings) {
                    decideScoreSubmission()
                },
                "ajax": {
                    "url": "{% url 'ajaxhandler' %}",
                    "dataSrc": function (json) {
{#                        console.log(json)#}
                        var data = json['message']['data']
                        var return_data = new Array();
                        for (var i = 0; i < data.length; i++) {
                            var action = '<span style="white-space:nowrap"> \
                                    <button class="btn btn-success btn-xs btn-detail decisionbtnfucker approve-submission" \
                                            value="' + data[i].id + '">Approve \
                                    </button> \
                                    <button class="btn btn-danger btn-xs btn-delete decisionbtnfucker deny-submission" \
                                            value="' + data[i].id + '">Deny \
                                    </button></span>';

                            var username = data[i].pointsinfo.user.discord_nickname
                            var discorduserid = data[i].pointsinfo.user.discord_id
                            var user = '<a href="/user/' + discorduserid + '">' + username + '</a>';

                            var managertext = '<textarea class="form-control" id="manager-note-' + data[i].id + '" rows="3"></textarea>'
                            var points = '<input class="form-control " type="number" value="'+data[i].points+'" id="points-manager-' + data[i].id + '">'


                            return_data.push({
                                'user': user,
                                'tank': data[i].tank.name+" (x"+data[i].tank.multiplier+")",
                                'gamemode': data[i].gamemode,
                                'score': data[i].score,
                                'date': data[i].date,
                                'points':points,
                                'submitter-note': data[i].submitterText,
                                'manager-note': managertext,
                                'proof': '<a href="' + data[i].proof + '">Prooflink</a>',
                                'action': action
                            })
                        }
                        return return_data;
                    },
                    "type": "POST",
                    "data": function (d) {
                        d.csrfmiddlewaretoken = csrftoken
                        d.ajax_action_id ={{ retrieveuserspointssubmissionsid }}
                    }
                },
                "columns": [
                    {"data": "user"},
                    {"data": "tank"},
{#                    {"data": "gamemode.name"},#}
                    {"data": "score"},
                    {"data": "proof"},
{#                    {"data": "date"},#}
                    {"data": "submitter-note"},
                    {"data": "manager-note"},
                    {"data": "points"},
                    {"data": "action"}

                ]
            });





            function decideFightSubmission() {
                $('.decisionbtnfightfucker').click(function () {
                    var id = $(this).val();
                    var element = $(this);
                    var points = $("#points-manager-"+id).val()
                    var managerText=$("#manager-note-"+id).val()
                    if (managerText=="")
                        managerText="None"


                    var accepted=$(this).hasClass("approve-submission")

                    element.closest("tr").find('input,button').attr('disabled','true');

                    $.ajax({
                        type: 'POST',
                        url: "{% url 'ajaxhandler' %}",
                        data: {csrfmiddlewaretoken: csrftoken,ajax_action_id:{{ decidefightsubmissionid }},pk_id:id,managerText:managerText, accepted: accepted, points: points},
                        success: function (data, textStatus, xhr) {
                            console.log(data);
                            console.log(xhr);
                            if (xhr.status == '200') {
                                //table.row(element.closest("tr")).remove().draw(false)
                                element.closest("tr").remove();
                                $('#alertsContainer').append("<div class=\"alert alert-success alert-dismissible fade in\" role=\"alert\"><button type=\"button\" class=\"close\" data-dismiss=\"alert\" aria-label=\"Close\"><span aria-hidden=\"true\">&times;</span></button>Approved Submission (" + data['message']['data']['id']+"): "+data['message']['data']['accepted'] + "<strong></div>")
                            }
                        }
                    });
                })
            }
            var tablefight=$('#fights-submissions-table').DataTable({
                "fnDrawCallback": function (oSettings) {
                    decideFightSubmission()
                },
                "ajax": {
                    "url": "{% url 'ajaxhandler' %}",
                    "dataSrc": function (json) {
                                                console.log(json)
                        var data = json['message']['data']
                        var return_data = new Array();
                        for (var i = 0; i < data.length; i++) {
                            var action = '<span style="white-space:nowrap"> \
                                    <button class="btn btn-success btn-xs btn-detail decisionbtnfightfucker approve-submission" \
                                            value="' + data[i].id + '">Approve \
                                    </button> \
                                    <button class="btn btn-danger btn-xs btn-delete decisionbtnfightfucker deny-submission" \
                                            value="' + data[i].id + '">Deny \
                                    </button></span>';

                            var username1 = data[i].pointsinfo.user.discord_nickname
                            var discorduserid1 = data[i].pointsinfo.user.discord_id
                            var winner = '<a href="/user/' + discorduserid1 + '">' + username1 + '</a>';

                            var username2 = data[i].pointsinfoloser.user.discord_nickname
                            var discorduserid2 = data[i].pointsinfoloser.user.discord_id
                            var loser = '<a href="/user/' + discorduserid2 + '">' + username2 + '</a>';


                            var managertext = '<textarea class="form-control" id="manager-note-' + data[i].id + '" rows="3"></textarea>'
                            var pointswinner = '<input class="form-control" type="number" value="'+data[i].points+'" id="points-manager-' + data[i].id + '">'
                            var pointsloser = '<input class="form-control" type="number" value="'+data[i].pointsloser+'" id="points-manager-' + data[i].id + '">'

                            return_data.push({
                                'winner': winner,
                                'loser': loser,
                                'proof': '<a href="' + data[i].proof + '">Prooflink</a>',
                                'pointswinner':pointswinner,
                                'pointsloser':pointsloser,
                                'manager-note': managertext,
                                'action': action
                            })
                        }
                        return return_data;
                    },
                    "type": "POST",
                    "data": function (d) {
                        d.csrfmiddlewaretoken = csrftoken
                        d.ajax_action_id = {{ retrieveuserfightssubmissionsid }}
                    }
                },
                "columns": [
                    {"data": "winner"},
                    {"data": "loser"},
                    {"data": "proof"},
                    {"data": "manager-note"},
                    {"data": "pointswinner"},
                    {"data": "pointsloser"},
                    {"data": "action"}

                ]
            });








            setInterval( function () {
                tablescore.ajax.reload();
            }, 1000*60*10 );
        });







    </script>
{% endblock %}
